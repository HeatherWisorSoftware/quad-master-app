@page "/QuadsPage/{TournamentId:int}/Quads"
@inject TournamentContext DbContext
@inject NavigationManager NavigationManager
@inject IToastService ToastService
@rendermode InteractiveServer

<h3>Tournament Quads - @ViewModel?.TournamentName</h3>

<div class="row mb-3">
    <div class="col-12 col-md-6">
        @if (ViewModel != null)
        {
            @if (ViewModel.AllowQuadGeneration)
            {
                <button class="btn btn-primary" style="padding: 8px 16px; margin: 10px;" @onclick ="GenerateQuads">Generate Quads</button>
            }
            <button class="btn btn-primary" style="padding: 8px 16px; margin: 10px;" @onclick="() => NavigateToPage(ViewModel.CurrentPage + 1)" disabled="@(ViewModel.CurrentPage >= ViewModel.TotalPages)">Next</button>
            <button class="btn btn-primary" style="padding: 8px 16px;margin: 10px:" @onclick="() => NavigateToPage(ViewModel.CurrentPage - 1)" disabled="@(ViewModel.CurrentPage <= 1)">Previous</button>
            <span class="mx-2">Page @ViewModel.CurrentPage of @ViewModel.TotalPages</span>
            
        }
    </div>
</div>

@if (ViewModel == null)
{
    <p>Loading...</p>
}
else
{
    <div class="row">
        <div class="col-12 col-lg-8">
            <h4>Current Quads</h4>
            @foreach (var quad in ViewModel.Quads)
            {
                <QuadsScoreBoard @key="quad.Id"
                                 Quad="quad"
                                 AllowPlayerRemoval="ViewModel.AllowPlayerRemoval"
                                 OnPlayerRemoved="RemovePlayerFromQuad" />
            }
        </div>
        <div class="col-12 col-lg-4">
            <h4>Unassigned Players (@ViewModel.UnassignedPlayers.Count)</h4>
            @if (ViewModel.UnassignedPlayers.Any())
            {
                <div class="card">
                    <div class="card-body">
                        <ul class="list-group">
                            @foreach (var player in ViewModel.UnassignedPlayers.OrderBy(p => p.Player.Ranking))
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    @player.Player.FirstName @player.Player.LastName (@player.Player.Ranking)
                                    @if (ViewModel.AllowPlayerAssignment)
                                    {
                                        <div class="input-group" style="max-width: 250px;">
                                            <select class="form-select" @bind="selectedQuadId">
                                                <option value="">Select Quad</option>
                                                @foreach (var quad in ViewModel.AllQuads)
                                                {
                                                    <option value="@quad.Id">@quad.Title</option>
                                                }
                                            </select>
                                            <button class="btn btn-outline-secondary"
                                                    @onclick="async () => await AssignPlayerToQuad(player.Id)"
                                                    disabled="@(string.IsNullOrEmpty(selectedQuadId?.ToString()))">
                                                Assign
                                            </button>
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            }
            else
            {
                <p>No unassigned players.</p>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public int TournamentId { get; set; } = 1;

    private QuadsViewModel? ViewModel { get; set; }
    private int? selectedQuadId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var tournament = await DbContext.Tournaments
            .Include(t => t.Quads)
            .FirstOrDefaultAsync(t => t.Id == TournamentId);

        if (tournament == null)
        {
            NavigationManager.NavigateTo("/tournaments");
            return;
        }

        int currentPage = ViewModel?.CurrentPage ?? 1;

        // Get all quads for this tournament
        var allQuads = await DbContext.Quads
            .Where(q => q.TournamentId == TournamentId)
            .ToListAsync();

        // Calculate total pages based on 2 quads per page
        int totalQuads = allQuads.Count;
        int pageSize = 2; // 2 quads per page
        int totalPages = (int)Math.Ceiling(totalQuads / (double)pageSize);
        totalPages = totalPages == 0 ? 1 : totalPages;

        // Ensure current page is valid
        if (currentPage > totalPages)
        {
            currentPage = totalPages;
        }

        // Get current page quads
        int skip = (currentPage - 1) * pageSize;
        var currentPageQuads = allQuads
            .OrderBy(q => q.QuadGroupNumber)
            .Skip(skip)
            .Take(pageSize)
            .ToList();

        // Include players in the quads
        foreach (var quad in currentPageQuads)
        {
            quad.Players = await DbContext.TournamentPlayers
                .Include(tp => tp.Player)
                .Where(tp => tp.QuadId == quad.Id)
                .ToListAsync();
        }

        // Get unassigned players
        var unassignedPlayers = await DbContext.TournamentPlayers
            .Include(tp => tp.Player)
            .Where(tp => tp.TournamentId == TournamentId && !tp.QuadId.HasValue)
            .ToListAsync();

        // Update ViewModel
        ViewModel = new QuadsViewModel
            {
                TournamentId = TournamentId,
                TournamentName = tournament.Name,
                Quads = currentPageQuads,
                AllQuads = allQuads,
                UnassignedPlayers = unassignedPlayers,
                CurrentPage = currentPage,
                TotalPages = totalPages,
                AllowQuadGeneration = true,
                AllowPlayerRemoval = true,
                AllowPlayerAssignment = true,
                AreAllQuadsFull = allQuads.Count > 0 && allQuads.All(q => q.Players.Count == 4)
            };
    }

    private async Task NavigateToPage(int page)
    {
        if (page < 1 || page > ViewModel.TotalPages)
            return;

        ViewModel.CurrentPage = page;
        await LoadData();
    }

    private async Task GenerateQuads()
    {
        // Get all unassigned players
        var unassignedPlayers = await DbContext.TournamentPlayers
            .Include(tp => tp.Player)
            .Where(tp => tp.TournamentId == TournamentId && !tp.IsAssigned)
            .OrderBy(tp => tp.Player.Ranking)
            .ToListAsync();

        // Find the highest quad group number for this tournament
        var highestGroupNumber = await DbContext.Quads
            .Where(q => q.TournamentId == TournamentId)
            .Select(q => q.QuadGroupNumber)
            .DefaultIfEmpty(0)
            .MaxAsync();

        // Create quads with 4 players each
        int quadCounter = 0;
        int playerCounter = 0;
        Quad currentQuad = null;

        while (playerCounter < unassignedPlayers.Count)
        {
            // Create a new quad for every 4 players
            if (playerCounter % 4 == 0)
            {
                quadCounter++;
                currentQuad = new Quad
                    {
                        Title = $"Quad {quadCounter}",
                        TournamentId = TournamentId,
                        QuadGroupNumber = highestGroupNumber + (int)Math.Ceiling(quadCounter / 4.0)
                    };

                DbContext.Quads.Add(currentQuad);
                await DbContext.SaveChangesAsync(); // Save to get Id
            }

            // Assign player to the quad
            var player = unassignedPlayers[playerCounter];
            player.QuadId = currentQuad.Id;
            playerCounter++;
        }

        await DbContext.SaveChangesAsync();
        ToastService.ShowSuccess("Quads generated successfully.");
        await LoadData();
    }

    private async Task RemovePlayerFromQuad(int playerId)
    {
        var tournamentPlayer = await DbContext.TournamentPlayers
            .FirstOrDefaultAsync(tp => tp.Id == playerId);

        if (tournamentPlayer != null)
        {
            tournamentPlayer.QuadId = null;
            await DbContext.SaveChangesAsync();
            ToastService.ShowInfo("Player removed from quad.");
            await LoadData();
        }
    }

    private async Task AssignPlayerToQuad(int playerId)
    {
        if (!selectedQuadId.HasValue)
        {
            ToastService.ShowWarning("Please select a quad first.");
            return;
        }

        var tournamentPlayer = await DbContext.TournamentPlayers
            .FirstOrDefaultAsync(tp => tp.Id == playerId);

        if (tournamentPlayer != null)
        {
            // Check if the quad already has 4 players
            var playersInQuad = await DbContext.TournamentPlayers
                .CountAsync(tp => tp.QuadId == selectedQuadId.Value);

            if (playersInQuad >= 4)
            {
                ToastService.ShowError("This quad already has 4 players.");
                return;
            }

            tournamentPlayer.QuadId = selectedQuadId.Value;
            await DbContext.SaveChangesAsync();
            ToastService.ShowSuccess("Player assigned to quad.");
            await LoadData();
        }
    }
}